# Implementation Plan: TSE-0001.12.0b - Prometheus Metrics (trading-system-engine-py)

**Epic:** TSE-0001 - Foundation Services & Infrastructure
**Milestone:** TSE-0001.12.0b - Prometheus Metrics (Clean Architecture)
**Branch:** `feature/TSE-0001.12.0b-prometheus-metrics-client`
**Date:** 2025-10-09

## Objective

Implement Prometheus metrics collection for trading-system-engine-py using **Clean Architecture principles** (port/adapter pattern), following the proven implementation from risk-monitor-py and audit-correlator-go.

## Architecture Pattern

**Clean Architecture (Port/Adapter):**
```
Domain Layer (Port)
    ↓ defines interface
Infrastructure Layer (Adapter)
    ↓ implements port
Presentation Layer
    ↓ uses port abstraction
```

**Key Principle:** Domain layer never depends on infrastructure. Future OpenTelemetry migration requires only swapping the adapter.

## RED Pattern Metrics

**Rate:** `http_requests_total` - Counter for all HTTP requests
**Errors:** `http_request_errors_total` - Counter for 4xx/5xx responses
**Duration:** `http_request_duration_seconds` - Histogram for request latency

**Labels (Low Cardinality):**
- `service` - Service name (e.g., "trading-system-engine")
- `instance` - Instance identifier (e.g., "trading-system-engine-LH")
- `version` - Service version
- `method` - HTTP method (GET, POST, etc.)
- `route` - Route pattern (not full path)
- `code` - HTTP status code

## Implementation Phases

### Phase 0: Setup ✅
- [x] Create feature branch
- [x] Create implementation plan
- [ ] Update TODO.md
- [ ] Update TODO-MASTER.md

### Phase 1: Domain Layer - MetricsPort Tests (RED)
- [ ] Create `tests/unit/domain/ports/test_metrics_port.py`
- [ ] Write 8 BDD tests for MetricsPort protocol

### Phase 2: Domain Layer - MetricsPort Implementation (GREEN)
- [ ] Create `src/trading_system/domain/ports/metrics.py`
- [ ] Implement MetricsPort Protocol
- [ ] Implement MetricsLabels dataclass

### Phase 3: Infrastructure - PrometheusAdapter Tests (RED)
- [ ] Create `tests/unit/infrastructure/observability/test_prometheus_adapter.py`
- [ ] Write 11 BDD tests for PrometheusMetricsAdapter

### Phase 4: Infrastructure - PrometheusAdapter Implementation (GREEN)
- [ ] Create `src/trading_system/infrastructure/observability/prometheus_adapter.py`
- [ ] Implement PrometheusMetricsAdapter class
- [ ] Thread-safe lazy initialization
- [ ] Custom registry with runtime metrics

### Phase 5: Infrastructure - Middleware Tests (RED)
- [ ] Create `tests/unit/infrastructure/observability/test_metrics_middleware.py`
- [ ] Write BDD tests for RED metrics middleware

### Phase 6: Infrastructure - Middleware Implementation (GREEN)
- [ ] Create `src/trading_system/infrastructure/observability/metrics_middleware.py`
- [ ] Implement `create_red_metrics_middleware()`

### Phase 7: Presentation - Metrics Router Tests (RED)
- [ ] Create `tests/unit/presentation/test_metrics_endpoint.py`
- [ ] Write BDD tests for /metrics endpoint

### Phase 8: Presentation - Metrics Router Implementation (GREEN)
- [ ] Create `src/trading_system/presentation/metrics.py`
- [ ] Implement `/api/v1/metrics` endpoint

### Phase 9: Application Integration
- [ ] Update `src/trading_system/main.py` with adapter initialization
- [ ] Pass metrics_port to create_app()
- [ ] Register middleware and router

### Phase 10: Integration Tests
- [ ] Create `tests/integration/test_metrics_integration.py`
- [ ] Write end-to-end BDD tests

### Phase 11: Documentation
- [ ] Create PR documentation
- [ ] Document architecture and changes
- [ ] Document test results

### Phase 12: Final Validation
- [ ] Run full test suite
- [ ] Verify Clean Architecture compliance
- [ ] Manual /metrics endpoint testing

### Phase 13: Commit and PR
- [ ] Commit all changes
- [ ] Update TODO files
- [ ] Push to remote

## Expected Deliverables

**New Files (12):**
1. Domain: `src/trading_system/domain/ports/metrics.py`
2. Infrastructure: `src/trading_system/infrastructure/observability/prometheus_adapter.py`
3. Infrastructure: `src/trading_system/infrastructure/observability/metrics_middleware.py`
4. Presentation: `src/trading_system/presentation/metrics.py`
5. Tests: 5 test files (8 + 11 + 5 + 4 + 5 = 33 tests)
6. Docs: Implementation plan, PR documentation

**Modified Files (2):**
1. `src/trading_system/main.py`
2. `TODO.md`, `TODO-MASTER.md`

**Test Coverage:**
- Domain layer: 8 tests
- Infrastructure: 16 tests
- Presentation: 4 tests
- Integration: 5 tests
- **Total new tests: ~33**
- **Total tests: ~152** (119 existing + 33 new)

## BDD Acceptance Criteria

✅ Trading System Engine exposes `/api/v1/metrics` endpoint with Prometheus format
✅ RED pattern metrics collected for all HTTP requests
✅ Metrics use Clean Architecture (MetricsPort abstraction)
✅ Domain layer has zero Prometheus dependencies
✅ Can mock MetricsPort for testing
✅ Python runtime metrics included (process, GC, platform)
✅ Constant labels applied (service, instance, version)
✅ Future OpenTelemetry migration requires only adapter swap

## Pattern Consistency

This implementation matches:
- **risk-monitor-py**: Same MetricsPort interface, PrometheusAdapter, RED middleware
- **audit-correlator-go**: Same architectural pattern (port/adapter)

---

**Status:** In Progress
**Created:** 2025-10-09
**Author:** Claude Code (TSE Trading Ecosystem Team)
